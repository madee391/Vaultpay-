import { createClient } from 'npm:@supabase/supabase-js';

Deno.serve(async (req: Request) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!, 
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );

  const { user } = await supabase.auth.getUser(req.headers.get('Authorization'));

  const apiKey = Deno.env.get('FOREX_API_KEY');
  const baseCurrency = new URL(req.url).searchParams.get('base') || 'USD';

  try {
    const response = await fetch(`https://api.exchangerate.host/latest?base=${baseCurrency}&apikey=${apiKey}`);
    const data = await response.json();

    await supabase.from('forex_rates').upsert({
      base_currency: baseCurrency,
      rates: JSON.stringify(data.rates),
      last_updated: new Date().toISOString()
    });

    return new Response(JSON.stringify(data), {
      headers: { 
        'Content-Type': 'application/json',
        'Cache-Control': 'public, max-age=3600'
      }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
});
