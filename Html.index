<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vaultpay - Deposit & Withdraw</title>
<style>
  /* Simple Dcash style inspired */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #f0f0f0;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  header {
    background: #1f1f1f;
    width: 100%; padding: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.1rem;
    color: #00e676;
  }
  main {
    max-width: 400px;
    width: 100%;
    padding: 1rem;
  }
  .balance-container {
    background: #222;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-around;
    font-weight: 600;
  }
  button {
    background: #00e676;
    border: none;
    color: #121212;
    font-weight: 700;
    padding: 0.75rem 1rem;
    margin: 0.5rem 0;
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #00c853;
  }
  #currency-select {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
  }
  #transaction-history {
    background: #222;
    border-radius: 8px;
    padding: 1rem;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.9rem;
  }
  #transaction-history h3 {
    margin-top: 0;
  }
  /* WhatsApp floating button */
  #whatsapp-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #25d366;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.3s ease;
  }
  #whatsapp-btn:hover {
    background: #1ebe57;
  }
  #whatsapp-btn svg {
    width: 32px;
    height: 32px;
    fill: white;
  }
  /* Modal */
  #info-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  #info-modal .modal-content {
    background: #1e1e1e;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    max-width: 350px;
    color: #ccc;
    font-size: 0.95rem;
  }
  #info-modal .close-btn {
    cursor: pointer;
    color: #00e676;
    font-weight: 700;
    float: right;
    font-size: 1.2rem;
  }
  #info-modal h2 {
    margin-top: 0;
    color: #00e676;
  }
</style>
</head>
<body>

<header>Vaultpay</header>

<main>
  <button id="deriv-login-btn">Login with Deriv</button>

  <div class="balance-container" style="display:none;" id="balance-container">
    <div>USD: <span id="balance-usd">-</span></div>
    <div>GBP: <span id="balance-gbp">-</span></div>
    <div>KSH: <span id="balance-ksh">-</span></div>
  </div>

  <select id="currency-select" style="display:none;">
    <option value="usd" selected>USD</option>
    <option value="gbp">GBP</option>
    <option value="ksh">KSH</option>
  </select>

  <button id="deposit-btn" style="display:none;">Deposit</button>
  <button id="withdraw-btn" style="display:none;">Withdraw</button>

  <div id="transaction-history" style="display:none;">
    <h3>Transaction History</h3>
    <ul id="transactions-list" style="padding-left:1rem; list-style-type: disc;"></ul>
  </div>
</main>

<!-- Info Modal -->
<div id="info-modal">
  <div class="modal-content">
    <span class="close-btn" id="modal-close-btn">&times;</span>
    <h2>Deposit & Withdraw Info</h2>
    <p>
      Minimum deposit and withdrawal is 0.5 USD or GBP.<br />
      Markup of 2.5% is applied to all transactions.<br />
      Deposits and withdrawals are instant.<br />
      Contact us anytime on WhatsApp for support.<br />
      Affiliate link is embedded to support Vaultpay.<br />
    </p>
  </div>
</div>

<!-- WhatsApp Floating Button -->
<div id="whatsapp-btn" title="Contact on WhatsApp" aria-label="WhatsApp Contact">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M20.52 3.48A11.874 11.874 0 0 0 12 0C5.373 0 0 5.373 0 12c0 2.116.554 4.158 1.6 5.982L0 24l6.343-1.639A11.91 11.91 0 0 0 12 24c6.627 0 12-5.373 12-12 0-3.204-1.25-6.204-3.48-8.52zM12 22c-1.96 0-3.805-.603-5.34-1.62l-.383-.26-3.775.976.994-3.69-.248-.382A9.936 9.936 0 0 1 2 12c0-5.514 4.486-10 10-10s10 4.486 10 10-4.486 10-10 10zm5.52-7.88c-.283-.14-1.67-.823-1.93-.917-.26-.095-.45-.14-.64.14-.187.277-.723.917-.887 1.106-.16.188-.32.21-.594.07-.273-.14-1.154-.425-2.2-1.357-.812-.72-1.36-1.608-1.52-1.884-.157-.277-.017-.427.123-.566.126-.125.283-.325.423-.488.14-.16.187-.277.28-.46.093-.186.047-.348-.023-.488-.07-.14-.64-1.54-.877-2.11-.23-.552-.466-.48-.64-.49l-.55-.01c-.19 0-.5.07-.765.348-.265.277-1.015.99-1.015 2.41 0 1.42 1.04 2.795 1.185 2.985.14.187 2.05 3.127 4.97 4.38.695.3 1.237.48 1.66.615.697.22 1.33.19 1.83.115.56-.088 1.67-.68 1.9-1.34.234-.66.234-1.226.164-1.34-.07-.112-.26-.18-.54-.317z"/>
  </svg>
</div>

<script>
  const app_id = 93522; // Your Deriv app ID
  const affiliate_link = 'https://partners.deriv.com/rx?sidc=8B834F18-9089-4971-995A-5CBB8D7788EB&utm_campaign=dynamicworks&utm_medium=affiliate&utm_source=CU38529';
  const whatsapp_number = '254758419976'; // Your WhatsApp number (Kenya)
  const markup_percent = 2.5; // hidden markup %
  const min_deposit = 0.5;

  const usd_to_ksh = 128; 
  const gbp_to_ksh = 164; 

  // Elements
  const loginBtn = document.getElementById('deriv-login-btn');
  const balanceContainer = document.getElementById('balance-container');
  const balanceUSD = document.getElementById('balance-usd');
  const balanceGBP = document.getElementById('balance-gbp');
  const balanceKSH = document.getElementById('balance-ksh');
  const currencySelect = document.getElementById('currency-select');
  const depositBtn = document.getElementById('deposit-btn');
  const withdrawBtn = document.getElementById('withdraw-btn');
  const whatsappBtn = document.getElementById('whatsapp-btn');
  const transactionsList = document.getElementById('transactions-list');
  const transactionHistoryDiv = document.getElementById('transaction-history');
  const infoModal = document.getElementById('info-modal');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  let userToken = null;
  let userBalanceUSD = 0;
  let transactions = [];

  // Open WhatsApp link
  whatsappBtn.addEventListener('click', () => {
    window.open(`https://wa.me/${whatsapp_number}`, '_blank');
  });

  // Show deposit & withdraw info modal
  function showInfoModal() {
    infoModal.style.display = 'flex';
  }
  modalCloseBtn.addEventListener('click', () => {
    infoModal.style.display = 'none';
  });
  window.onclick = (e) => {
    if (e.target === infoModal) infoModal.style.display = 'none';
  };

  // Calculate markup hidden amount
  function applyMarkup(amount) {
    return amount * (1 + markup_percent / 100);
  }

  // Format currency nicely
  function formatCurrency(value, currency) {
    let symbol = '';
    switch (currency) {
      case 'usd': symbol = '$'; break;
      case 'gbp': symbol = 'Â£'; break;
      case 'ksh': symbol = 'KSh '; break;
    }
    return symbol + Number(value).toFixed(2);
  }

  // Deriv login button click
  loginBtn.addEventListener('click', () => {
    // Open Deriv OAuth login page with redirect_uri to your deployed page
    const redirect_uri = window.location.href; // Assuming same page handles callback
    const oauthUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${app_id}&l=EN&redirect_uri=${encodeURIComponent(redirect_uri)}&response_type=token&scope=read+trade`;
    window.location.href = oauthUrl;
  });

  // Parse token from URL hash after OAuth redirect
  function parseTokenFromUrl() {
    const hash = window.location.hash.substr(1);
    const params = new URLSearchParams(hash);
    const token = params.get('access_token');
    return token;
  }

  // Load balance from Deriv API
  async function fetchBalance(token) {
    try {
      const ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);
      ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: token }));
      };
      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.msg_type === 'authorize') {
          ws.send(JSON.stringify({ balance: 1 }));
        } else if (data.msg_type === 'balance') {
          userBalanceUSD = Number(data.balance.balance);
          updateBalances();
          ws.close();
        }
      };
    } catch (error) {
      alert('Failed to fetch balance. Try logging in again.');
    }
  }

  function updateBalances() {
    const usd_with_markup = applyMarkup(userBalanceUSD);
    const gbp = usd_with_markup * 0.78;
    const ksh = usd_with_markup * usd_to_ksh;

    balanceUSD.textContent = formatCurrency(usd_with_markup, 'usd');
    balanceGBP.textContent = formatCurrency(gbp, 'gbp');
    balanceKSH.textContent = formatCurrency(ksh, 'ksh');

    balanceContainer.style.display = 'flex';
    currencySelect.style.display = 'block';
    depositBtn.style.display = 'block';
    withdrawBtn.style.display = 'block';
    transactionHistoryDiv.style.display = 'block';
  }

  // Currency switch
  currencySelect.addEventListener('change', () => {
    updateBalances();
  });

  // Deposit button action
  depositBtn.addEventListener('click', () => {
    const currency = currencySelect.value;
    const amount = prompt(`Enter deposit amount in ${currency.toUpperCase()} (min ${min_deposit})`);
    if (!amount || isNaN(amount) || Number(amount) < min_deposit) {
      alert(`Invalid amount. Minimum is ${min_deposit} ${currency.toUpperCase()}.`);
      return;
    }
    const amount_with_markup = applyMarkup(Number(amount));
    const affiliateUrl = affiliate_link;
    alert(`Deposit amount with 2.5% markup: ${formatCurrency(amount_with_markup, currency)}`);
    // Redirect user to affiliate link or your WhatsApp with details
    const depositMsg = `I want to deposit ${amount_with_markup.toFixed(2)} ${currency.toUpperCase()} via Vaultpay.`;
    window.open(`https://wa.me/${whatsapp_number}?text=${encodeURIComponent(depositMsg)}`, '_blank');
  });

  // Withdraw button action
  withdrawBtn.addEventListener('click', () => {
    const currency = currencySelect.value;
    const amount = prompt(`Enter withdrawal amount in ${currency.toUpperCase()} (min ${min_deposit})`);
    if (!amount || isNaN(amount) || Number(amount) < min_deposit) {
      alert(`Invalid amount. Minimum is ${min_deposit} ${currency.toUpperCase()}.`);
      return;
    }
    const amount_with_markup = applyMarkup(Number(amount));
    alert(`Withdrawal amount with 2.5% markup: ${formatCurrency(amount_with_markup, currency)}`);
    const withdrawMsg = `I want to withdraw ${amount_with_markup.toFixed(2)} ${currency.toUpperCase()} via Vaultpay.`;
    window.open(`https://wa.me/${whatsapp_number}?text=${encodeURIComponent(withdrawMsg)}`, '_blank');
  });

  // Load transaction history (mock for now)
  function loadTransactions() {
    transactionsList.innerHTML = '';
    if (transactions.length === 0) {
      transactionsList.innerHTML = '<li>No transactions yet</li>';
      return;
    }
    transactions.forEach(tx => {
      const li = document.createElement('li');
      li.textContent = `${tx.type} ${formatCurrency(tx.amount, tx.currency)} on ${new Date(tx.date).toLocaleString()}`;
      transactionsList.appendChild(li);
    });
  }

  // On page load: check if token in URL
  window.onload = () => {
    const token = parseTokenFromUrl();
    if (token) {
      userToken = token;
      // Clean URL hash to not show token
      history.replaceState(null, null, ' ');
      fetchBalance(token);
      // Show deposit/withdraw etc after login
      loginBtn.style.display = 'none';
    }
  };

  loadTransactions();
</script>

</body>
</html>
