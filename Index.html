<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vaultpay</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #071019;
    --card: #0e1b23;
    --accent: #ffb400;
    --accent2: #12a26a;
    --muted: #98a8a6;
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: Inter, Arial, Helvetica, sans-serif;
    background: linear-gradient(180deg, var(--bg) 0%, #0b2530 100%);
    color: #fff;
  }
  .app {
    max-width: 920px;
    margin: 20px auto;
    padding: 16px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .brand {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .logo {
    width: 44px;
    height: 44px;
    border-radius: 8px;
    background: linear-gradient(90deg, var(--accent), #ff9b00);
  }
  h1 {
    margin: 0;
    font-size: 1.2rem;
  }
  .tag {
    color: var(--muted);
    font-size: 0.9rem;
  }
  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  button {
    background: var(--accent);
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    color: #111;
    font-weight: bold;
  }
  button:disabled {
    background: #444;
    cursor: not-allowed;
  }
  main {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap: 20px;
  }
  .card {
    background: var(--card);
    border-radius: 10px;
    padding: 16px;
  }
  .card h2 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 1.1rem;
    border-bottom: 1px solid var(--muted);
    padding-bottom: 8px;
  }
  .balance-amount {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 10px;
  }
  #transaction-history {
    max-height: 220px;
    overflow-y: auto;
    font-size: 0.9rem;
  }
  #transaction-history table {
    width: 100%;
    border-collapse: collapse;
    color: #eee;
  }
  #transaction-history th, #transaction-history td {
    border-bottom: 1px solid #444;
    padding: 6px 8px;
    text-align: left;
  }
  #transaction-history th {
    background: var(--bg);
    position: sticky;
    top: 0;
  }
  .floating-whatsapp {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: #25D366;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .floating-whatsapp svg {
    width: 32px;
    height: 32px;
    fill: white;
  }
  .info-link {
    color: var(--accent);
    cursor: pointer;
    text-decoration: underline;
  }
  /* Deposit and Withdraw info page modal */
  #info-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    z-index: 9998;
    justify-content: center;
    align-items: center;
  }
  #info-modal.active {
    display: flex;
  }
  #info-modal .modal-content {
    background: var(--card);
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    color: #ddd;
  }
  #info-modal h3 {
    margin-top: 0;
  }
  #info-modal button.close-btn {
    margin-top: 12px;
    background: var(--accent2);
    color: #111;
    font-weight: bold;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  /* Responsive */
  @media(max-width:480px){
    main {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Vaultpay</h1>
        <div class="tag">Deposit & Withdraw on Deriv</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="login-btn">Login with Deriv</button>
      <button id="logout-btn" style="display:none;">Logout</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Account Balance</h2>
      <div><strong>USD:</strong> <span id="balance-usd">-</span></div>
      <div><strong>GBP:</strong> <span id="balance-gbp">-</span></div>
      <div><strong>KSH:</strong> <span id="balance-ksh">-</span></div>
    </section>

    <section class="card">
      <h2>Actions</h2>
      <button id="deposit-btn">Deposit</button>
      <button id="withdraw-btn">Withdraw</button>
      <div style="margin-top:12px; font-size:0.9rem; color: var(--muted);">
        Minimum deposit/withdraw: 0.5 USD or GBP
      </div>
      <div style="margin-top:8px; font-size:0.85rem; color: var(--muted);">
        <span class="info-link" id="show-info">Deposit & Withdraw Info</span>
      </div>
    </section>

    <section class="card">
      <h2>Live Transaction History</h2>
      <div id="transaction-history">
        <table>
          <thead>
            <tr><th>ID</th><th>Type</th><th>Amount</th><th>Currency</th><th>Status</th><th>Time</th></tr>
          </thead>
          <tbody id="transaction-tbody">
            <tr><td colspan="6" style="text-align:center;">No transactions yet</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Deposit & Withdraw info modal -->
<div id="info-modal">
  <div class="modal-content">
    <h3>Deposit & Withdraw Information</h3>
    <p><strong>Deposit Methods:</strong></p>
    <ul>
      <li>M-Pesa - Minimum: 0.5 USD / GBP</li>
      <li>Bank Transfer - Minimum: 0.5 USD / GBP</li>
      <li>Binance - Minimum: 0.5 USD / GBP</li>
    </ul>
    <p><strong>Withdrawal Methods:</strong></p>
    <ul>
      <li>M-Pesa - Instant</li>
      <li>Bank Transfer - Instant</li>
      <li>Binance - Instant</li>
    </ul>
    <p>For assistance, contact us on WhatsApp.</p>
    <button class="close-btn" id="close-info">Close</button>
  </div>
</div>

<!-- WhatsApp floating button -->
<div class="floating-whatsapp" id="whatsapp-btn" title="Contact us on WhatsApp">
  <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
    <path d="M16 3C9.383 3 4 8.383 4 15c0 2.64.87 5.078 2.33 7.01L5 29l6.36-1.65a11.97 11.97 0 006.64 1.85c6.617 0 12-5.383 12-12S22.617 3 16 3zm6.46 17.13c-.28.77-1.58 1.45-2.19 1.54-.59.09-1.27.13-3.12-.57a12.306 12.306 0 01-3.62-2.24 12.62 12.62 0 01-2.37-2.93c-.28-.47-.56-1.29-.05-1.83l.5-.59c.31-.37.61-.49 1.03-.43.28.04.55.16.8.29.29.16.62.37.9.56.36.26.7.57 1.04.84.27.21.54.43.81.62.22.14.53.17.74.04.22-.13.72-.49.9-.63.2-.16.42-.32.6-.5.2-.21.42-.38.6-.57.18-.18.3-.46.35-.72.05-.23-.01-.44-.09-.61a3.97 3.97 0 00-.89-1.15c-.6-.56-1.45-1.07-2.23-1.27-.92-.25-1.52-.03-2.08.38-.17.12-.33.25-.49.37-.36.31-.72.67-1.08 1.01-.53.54-.92.98-1.17 1.62-.12.33-.2.67-.26 1-.02.17-.01.33 0 .5.02.16.04.32.1.48.11.31.35.52.58.7a2.913 2.913 0 001.23.64c.44.12.88.12 1.32.07a12.73 12.73 0 003.12-.7c.8-.3 1.57-.72 2.27-1.18.15-.1.28-.21.42-.32.06-.04.1-.06.14-.1l.01-.01z"></path>
  </svg>
</div>

<script>
  // Your Deriv App ID
  const app_id = 93522; // Your real app id here
  const derivAuthUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${app_id}&l=EN&brand=deriv&scope=read+trade+wallet&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&response_type=token`;

  // Markup for deposit/withdraw (hidden)
  const markupPercent = 2.5;

  // Currency rates
  const usd_to_ksh = 128;
  const gbp_to_ksh = 164;

  // Minimum deposit/withdraw limits
  const minAmountUSD = 0.5;
  const minAmountGBP = 0.5;

  // Store access token here after login
  let accessToken = null;

  // Elements
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const balanceUSD = document.getElementById('balance-usd');
  const balanceGBP = document.getElementById('balance-gbp');
  const balanceKSH = document.getElementById('balance-ksh');
  const depositBtn = document.getElementById('deposit-btn');
  const withdrawBtn = document.getElementById('withdraw-btn');
  const whatsappBtn = document.getElementById('whatsapp-btn');
  const transactionTbody = document.getElementById('transaction-tbody');
  const infoModal = document.getElementById('info-modal');
  const showInfoLink = document.getElementById('show-info');
  const closeInfoBtn = document.getElementById('close-info');

  // Open info modal
  showInfoLink.addEventListener('click', () => {
    infoModal.classList.add('active');
  });

  closeInfoBtn.addEventListener('click', () => {
    infoModal.classList.remove('active');
  });

  // WhatsApp link
  const whatsappNumber = "254758419976";

  whatsappBtn.addEventListener('click', () => {
    window.open(`https://wa.me/${whatsappNumber}`, '_blank');
  });

  // Login flow
  loginBtn.addEventListener('click', () => {
    const width = 500;
    const height = 600;
    const left = (window.screen.width / 2) - (width / 2);
    const top = (window.screen.height / 2) - (height / 2);

    const loginWindow = window.open(derivAuthUrl, 'DerivLogin', `width=${width},height=${height},top=${top},left=${left}`);

    // Listen for message from popup with token (OAuth implicit flow)
    window.addEventListener('message', (event) => {
      if (event.origin !== window.location.origin) return;
      if (event.data.access_token) {
        accessToken = event.data.access_token;
        localStorage.setItem('deriv_access_token', accessToken);
        loginWindow.close();
        afterLogin();
      }
    }, { once: true });
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    accessToken = null;
    localStorage.removeItem('deriv_access_token');
    resetUI();
  });

  // On page load check URL for token in hash (OAuth implicit flow)
  function checkTokenFromUrl() {
    const hash = window.location.hash;
    if (hash.includes('access_token=')) {
      const params = new URLSearchParams(hash.substring(1));
      accessToken = params.get('access_token');
      if (accessToken) {
        localStorage.setItem('deriv_access_token', accessToken);
        // Remove token from URL
        history.replaceState(null, null, window.location.pathname);
        afterLogin();
      }
    } else {
      accessToken = localStorage.getItem('deriv_access_token');
      if (accessToken) afterLogin();
    }
  }

  // Setup UI after login
  function afterLogin() {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    fetchBalance();
    fetchTransactions();
  }

  // Reset UI after logout
  function resetUI() {
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    balanceUSD.innerText = '-';
    balanceGBP.innerText = '-';
    balanceKSH.innerText = '-';
    transactionTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No transactions yet</td></tr>';
  }

  // Fetch balance from Deriv API
  async function fetchBalance() {
    try {
      const resp = await fetch('https://api.deriv.com/api/v1/wallet/balance', {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      if (!resp.ok) throw new Error('Failed to fetch balance');
      const data = await resp.json();
      const usdBalance = parseFloat(data.balance);
      const gbpBalance = (usdBalance * 0.78).toFixed(2); // approx conversion
      const kshBalance = (usdBalance * usd_to_ksh).toFixed(2);

      balanceUSD.innerText = `$${usdBalance.toFixed(2)}`;
      balanceGBP.innerText = `Â£${gbpBalance}`;
      balanceKSH.innerText = `KSh ${kshBalance}`;
    } catch (e) {
      console.error('Error fetching balance:', e);
      alert('Error fetching balance. Please try logging in again.');
      resetUI();
    }
  }

  // Fetch transactions (placeholder, since Deriv API might need different endpoint or real-time feed)
  function fetchTransactions() {
    // For demo, just show dummy transactions every 5s
    const dummyTxns = [
      {id:'TX1234', type:'Deposit', amount:'10.00', currency:'USD', status:'Success', time:'10:20 AM'},
      {id:'TX1235', type:'Withdraw', amount:'5.00', currency:'GBP', status:'Pending', time:'11:00 AM'},
      {id:'TX1236', type:'Deposit', amount:'0.5', currency:'USD', status:'Success', time:'11:15 AM'},
    ];
    transactionTbody.innerHTML = '';
    dummyTxns.forEach(tx => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${tx.id}</td>
        <td>${tx.type}</td>
        <td>${tx.amount}</td>
        <td>${tx.currency}</td>
        <td>${tx.status}</td>
        <td>${tx.time}</td>
      `;
      transactionTbody.appendChild(tr);
    });
  }

  // Deposit button
  depositBtn.addEventListener('click', () => {
    // Opens WhatsApp chat with deposit message + affiliate link + markup hidden
    const message = encodeURIComponent(`
